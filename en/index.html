<script>
  // ...（上略）
  Papa.parse(CSV_URL, {
    download: true,
    header: true,
    complete: function(results) {
      const data = results.data;
      data.forEach((row, i) => {
        // 過濾掉空行
        if (!row.Latitude || !row.Longitude) return;
        // DEBUG: 看欄位
        console.log("ROW:", row);

        const lat = parseFloat(row.Latitude);
        const lng = parseFloat(row.Longitude);
        if (isNaN(lat) || isNaN(lng)) return;

        const cid = 'chart' + i;
        const rateStr = (row["% of Votes in 2024"] || '').replace('%', '').replace(',', '.');
        const rate = parseFloat(rateStr) || 0;
        const rest = Math.max(0, 100 - rate);

        function formatNumber(num) {
          return Number(num || 0).toLocaleString('en-US');
        }

        const popupHTML = `
          <div class="popup-info" style="user-select:all; cursor:pointer;" title="Click to copy">
            <strong>${row.Name || ''} (${row.Date || ''})</strong><br>
            Party: ${row.Party || ''}<br>
            Electorate: ${formatNumber(row.Electorate)}<br>
            25% Threshold: ${formatNumber(row["25% Threshold"])}<br>
            Agree: ${formatNumber(row.Agree)}<br>
            Disagree: ${formatNumber(row.Disagree)}<br>
            <strong>Results: ${row.Results || 'N/A'}</strong><br>
            <br>
            <div class="popup-small"><strong>Elected (%)</strong></div>
            <canvas id="${cid}" class="popup-chart"></canvas>
          </div>
        `;
        const marker = L.circleMarker([lat, lng], {
          radius: 8,
          color: row.Color || 'gray',
          fillColor: row.Color || 'gray',
          fillOpacity: 0.6
        }).addTo(map);

        marker.bindPopup(popupHTML);

        marker.on('popupopen', () => {
          const div = document.getElementById(cid).parentElement;
          div.onclick = function() {
            navigator.clipboard.writeText(div.innerText.replace(/\s+/g, ' ').trim());
            div.title = "Copied!";
            setTimeout(()=>{ div.title = "Click to copy"; },1000);
          };
          new Chart(document.getElementById(cid).getContext('2d'), {
            type: 'pie',
            data: {
              labels: ['Elected', 'Others'],
              datasets: [{
                data: [rate, rest],
                backgroundColor: ['#007bff', '#e9ecef']
              }]
            },
            options: {
              plugins: {
                legend: { position: 'bottom' }
              }
            }
          });
        });

        marker.rowDate = row.Date;
        markers.push(marker);
      });

      document.getElementById('loading').style.display = 'none';
      filterByDate('all');
    }
  });
</script>
