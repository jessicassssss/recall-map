<script>
  const map = L.map('map').setView([23.8, 121], 7);

  // 英文地名底圖（Carto）
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; <a href="https://carto.com/">CARTO</a>',
    subdomains: 'abcd',
    maxZoom: 19
  }).addTo(map);

  const markers = [];

  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQoU8mUSfNo-u54-3sVevNDp59orI5WJSIiiKimGFYQ581z3Yh7V0DzdE7cDy4vLKwwoy99ud8EiMCm/pub?output=csv";

  Papa.parse(CSV_URL, {
    download: true,
    header: true,
    complete: function(results) {
      const data = results.data;
      data.forEach((row, i) => {
        const lat = parseFloat(row.Latitude);
        const lng = parseFloat(row.Longitude);
        if (isNaN(lat) || isNaN(lng)) return;

        const rateStr = (row.ElectionRate_2024 || "").replace('%', '');
        const rate = parseFloat(rateStr) || 0;
        const rest = Math.max(0, 100 - rate);

        const marker = L.circleMarker([lat, lng], {
          radius: 8,
          color: row.Color || "gray",
          fillColor: row.Color || "gray",
          fillOpacity: 0.6
        }).addTo(map);

        const cid = 'chart' + i;
        const popup = `
          <div style="text-align:left; font-size:14px; max-width:220px;">
            <strong>${row.Name} (${row.Date})</strong><br>
            Party: ${row.Party}<br>
            Electorate: ${Number(row.Electorate).toLocaleString()}<br>
            25% Threshold: ${Number(row['Threshold_25%']).toLocaleString()}<br>
            <br>
            <strong>2024 Election Vote Rate</strong><br>
            <canvas id="${cid}" class="popup-chart"></canvas>
            <div style="font-size:13px; text-align:center; margin-top:4px;">
              Candidate / Others
            </div>
          </div>`;

        marker.bindPopup(popup);
        marker.on('popupopen', () => {
          new Chart(document.getElementById(cid).getContext('2d'), {
            type: 'pie',
            data: {
              labels: ['Candidate', 'Others'],
              datasets: [{
                data: [rate, rest],
                backgroundColor: ['#007bff', '#e9ecef']
              }]
            },
            options: {
              plugins: {
                legend: { display: false }
              }
            }
          });
        });

        marker.rowDate = row.Date;
        markers.push(marker);
      });

      filterByDate('all');
    }
  });

  function filterByDate(d) {
    markers.forEach(m => {
      (d === 'all' || m.rowDate === d)
        ? m.addTo(map)
        : map.removeLayer(m);
    });
  }
</script>
